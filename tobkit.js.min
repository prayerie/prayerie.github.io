const colscheme={col_bg:{hex:"20317b",name:"Background"},col_env_bg:{hex:"20317b",name:"Envelope editor background"},col_medium_bg:{hex:"4a5a8b",name:"Medium background"},col_light_bg:{hex:"8394c5",name:"Light background"},col_lighter_bg:{hex:"bdcdff",name:"Lighter background"},col_light_ctrl:{hex:"ffff00",name:"Light control / button gradient 1"},col_dark_ctrl:{hex:"ff9400",name:"Dark control / button gradient 2"},col_light_ctrl_disabled:{hex:"8394c5",name:"Light control (disabled)"},col_dark_ctrl_disabled:{hex:"4a5a8b",name:"Dark control (disabled)"},col_selected_tab:{hex:"8394c5",name:"Selected tab"},col_unselected_tab:{hex:"4a5a8b",name:"Unselected tab"},col_list_1:{hex:"4a5a8b",name:"List item gradient 1"},col_list_2:{hex:"8394c5",name:"List item gradient 2"},col_list_highlight1:{hex:"e67b00",name:"List item gradient 1 (highlighted)"},col_list_highlight2:{hex:"e6e600",name:"List item gradient 2 (highlighted)"},col_scrollbar_bg1:{hex:"4a5a8b",name:"Scrollbar background gradient 1"},col_scrollbar_bg2:{hex:"8394c5",name:"Scrollbar background gradient 2"},col_scrollbar_inactive:{hex:"ff9400",name:"Scrollbar thumb (inactive)"},col_scrollbar_active:{hex:"ffff00",name:"Scrollbar thumb (active)"},col_scrollbar_arr_bg1:{hex:"ff9400",name:"Scrollbar arrow background gradient 1"},col_scrollbar_arr_bg2:{hex:"ffff00",name:"Scrollbar arrow background gradient 2"},col_outline:{hex:"000000",name:"Widget outline"},col_tab_outline:{hex:"000000",name:"Tab/tab box outline"},col_sepline:{hex:"ffff00",name:"List item separator line"},col_icon_tab:{hex:"000000",name:"Tab icon"},col_icon:{hex:"000000",name:"Button icon and scrollbar arrows"},col_checkmark:{hex:"000000",name:"Checkmark"},col_text:{hex:"000000",name:"Text"},col_text_light:{hex:"8394c5",name:"Text (light)"},col_text_bt:{hex:"000000",name:"Text (buttons)"},col_text_value:{hex:"000000",name:"Text (value input)"},col_text_lb:{hex:"000000",name:"Text (list items)"},col_text_lb_highlight:{hex:"000000",name:"Text (highlighted list item)"},col_signal:{hex:"ff0000",name:"Recording/signal (red)"},col_signal_off:{hex:"940000",name:"Recording/signal (off, dark red)"},col_piano_label:{hex:"000000",name:"Piano mapping label (naturals)"},col_piano_label_inv:{hex:"ffffff",name:"Piano mapping label (inverted, sharps)"},col_loop:{hex:"39cd29",name:"Loop points"},col_env_sustain:{hex:"00ff00",name:"Envelope sustain line"},col_env_line:{hex:"ff9400",name:"Envelope line"},col_env_pt:{hex:"ffff00",name:"Envelope point fill"},col_env_pt_border:{hex:"000000",name:"Envelope point outline"},col_env_pt_border_active:{hex:"ff0000",name:"Envelope point outline (active)"},col_mem_ok:{hex:"8bc583",name:"Memory usage: OK"},col_mem_warn:{hex:"ffff00",name:"Memory usage: Warning"},col_mem_alert:{hex:"ff0000",name:"Memory usage: Alert"},col_typewriter_cursor:{hex:"000000",name:"Text entry cursor"},col_smp_bg:{hex:"20317b",name:"Sample editor background"},col_smp_bg_sel:{hex:"ffff00",name:"Sample editor background (selection)"},col_smp_waveform:{hex:"ff9c00",name:"Sample editor waveform"},col_smp_waveform_sel:{hex:"000000",name:"Sample editor waveform (selection)"},col_pv_bg:{hex:"20317b",name:"Pattern - background"},col_pv_chn:{hex:"8394c5",name:"Pattern - channel number"},col_pv_lines:{hex:"8394c5",name:"Pattern - lines"},col_pv_sublines:{hex:"394a8b",name:"Pattern - sublines"},col_pv_lines_record:{hex:"ff9400",name:"Pattern - lines (recording)"},col_pv_cb_col1:{hex:"4a5a8b",name:"Pattern - cursor bar gradient 1"},col_pv_cb_col2:{hex:"8394c5",name:"Pattern - cursor bar gradient 2"},col_pv_cb_col1_highlight:{hex:"e67b00",name:"Pattern - cursor bar gradient 1 (highlight)"},col_pv_cb_col2_highlight:{hex:"e6e600",name:"Pattern - cursor bar gradient 2 (highlight)"},col_pv_left_numbers:{hex:"e67b00",name:"Pattern - row numbers"},col_pv_notes:{hex:"4a7bff",name:"Pattern - notes"},col_pv_notes_dark:{hex:"0031d5",name:"Pattern - notes (dark)"},col_pv_instr:{hex:"ff5a00",name:"Pattern - instruments"},col_pv_instr_dark:{hex:"a43100",name:"Pattern - instruments (dark)"},col_pv_volume:{hex:"00de00",name:"Pattern - volume"},col_pv_volume_dark:{hex:"008300",name:"Pattern - volume (dark)"},col_pv_effect:{hex:"ff62ee",name:"Pattern - effect command"},col_pv_effect_dark:{hex:"623194",name:"Pattern - effect command (dark)"},col_pv_effect_param:{hex:"f6d541",name:"Pattern - effect parameter"},col_pv_effect_param_dark:{hex:"4a4129",name:"Pattern - effect parameter (dark)"},col_pv_cb_sel_highlight:{hex:"ffc500",name:"Pattern - selection"},col_pv_pb:{hex:"000000",name:"Pattern - row outline"},col_pv_pb_cell:{hex:"000000",name:"Pattern - cursor outline"},col_pv_mutesolo_text:{hex:"000000",name:"Pattern - mute/solo text color"},col_pv_mutesolo_col1:{hex:"4a5a8b",name:"Pattern - mute/solo gradient 1"},col_pv_mutesolo_col2:{hex:"8394c5",name:"Pattern - mute/solo gradient 2"},col_pv_mutesolo_col1_highlight:{hex:"e67b00",name:"Pattern - mute/solo gradient 1 (highlight)"},col_pv_mutesolo_col2_highlight:{hex:"e6e600",name:"Pattern - mute/solo gradient 2 (highlight)"},col_pv_left_numbers_highlight:{hex:"e67b00",name:"Pattern - row numbers (highlight)"},col_list_sep_vertical:{hex:"ffff00",name:"List item separator line (vertical)"},col_tb_bg:{hex:"ff9400",name:"Togglebutton background"},col_tb_fg_off:{hex:"000000",name:"Togglebutton foreground (off)"},col_tb_fg_on:{hex:"ffff00",name:"Togglebutton foreground (on)"}},cols_ordered=Object.keys(colscheme);let base_colours={},colours={},lockcols=!1,active=null,hue=0,sat=1,lit=.5;const inp=document.getElementById("input"),parseres=document.getElementById("parseres"),swatch_list=document.getElementById("swatches"),load_btn=document.getElementById("load-btn"),spec_canvas=document.getElementById("spectrum-canvas"),spec_ctx=spec_canvas.getContext("2d"),spec_cursor=document.getElementById("spectrum-cursor"),hue_canvas=document.getElementById("hue-canvas"),hue_ctx=hue_canvas.getContext("2d"),hue_cursor=document.getElementById("hue-cursor"),prev_canvas=document.getElementById("preview-canvas"),fb_sub=prev_canvas.getContext("2d");fb_sub.imageSmoothingEnabled=!1;let font_img=new Image,font_loaded=!1;font_img.onload=()=>{font_loaded=!0,redraw()},font_img.src="font_8x11.png";let icons_loaded=0;const icons={};["icon_song","icon_disk","icon_sample","icon_trumpet","icon_wrench","icon_play","icon_pause","icon_stop","icon_flp","icon_undo","icon_redo","haken","icon_record"].forEach((o=>{const e=new Image;e.onload=()=>{const t=document.createElement("canvas");t.width=e.width,t.height=e.height;const l=t.getContext("2d");l.drawImage(e,0,0);const r=l.getImageData(0,0,e.width,e.height).data,c=[];for(let o=0;o<r.length;o+=4)c.push(r[o]<128?1:0);icons[o]={w:e.width,h:e.height,bits:c},icons_loaded++,redraw()},e.src=o+".png"}));let piano_img=new Image,piano_loaded=!1;piano_img.onload=()=>{piano_loaded=!0,redraw()},piano_img.src="piano.png";let logo_img=new Image,logo_loaded=!1;logo_img.onload=()=>{logo_loaded=!0,redraw()},logo_img.src="logo.png";let font_3x5_img=new Image,font_3x5_loaded=!1;font_3x5_img.onload=()=>{font_3x5_loaded=!0,redraw()},font_3x5_img.src="font_3x5.png";const prev_canvas_main=document.getElementById("preview-canvas-main"),fb_main=prev_canvas_main.getContext("2d");fb_main.imageSmoothingEnabled=!1;const pv_char_w=4,pv_char_h=8,pv_cell_h=8,pv_border_w=10,pv_cols=4,pv_rows=64,pv_cursorbar_y=88,pv_cellw=32;let sel_x1=0,sel_y1=0,sel_x2=0,sel_y2=0;const font_index=[64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,92,63,62,69,86,70,71,84,72,73,67,65,74,66,75,79,52,53,54,55,56,57,58,59,60,61,81,87,76,77,78,64,64,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,82,80,83,90,68,64,0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,88,64,89,91,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64],font_widths=[6,6,6,6,6,4,6,6,2,4,6,2,8,6,6,6,6,4,6,4,6,7,8,7,6,6,7,7,7,7,7,7,7,7,2,7,7,7,8,8,7,7,7,7,7,8,7,7,8,8,8,7,6,6,6,6,6,6,6,6,6,6,5,2,7,6,5,6,6,7,7,7,4,4,3,2,4,4,4,4,5,2,4,4,3,6,6,3,4,4,6,8,3],mem_use=Math.floor(100*Math.random())+1,scalexy=2,tobkitSimilarCols={col_light_ctrl_disabled:"col_light_bg",col_dark_ctrl_disabled:"col_medium_bg",col_selected_tab:"col_light_bg",col_unselected_tab:"col_medium_bg",col_list_1:"col_medium_bg",col_list_2:"col_light_bg",col_scrollbar_bg1:"col_medium_bg",col_scrollbar_bg2:"col_light_bg",col_scrollbar_inactive:"col_dark_ctrl",col_scrollbar_active:"col_light_ctrl",col_scrollbar_arr_bg1:"col_dark_ctrl",col_scrollbar_arr_bg2:"col_light_ctrl",col_tab_outline:"col_outline",col_icon_tab:"col_icon",col_env_bg:"col_bg",col_env_line:"col_dark_ctrl",col_env_pt:"col_light_ctrl",col_env_pt_border:"col_outline",col_env_pt_border_active:"col_signal",col_smp_bg:"col_bg",col_smp_bg_sel:"col_light_ctrl",col_pv_bg:"col_bg",col_pv_lines:"col_light_bg",col_pv_lines_record:"col_dark_ctrl",col_pv_cb_col1:"col_medium_bg",col_pv_cb_col2:"col_light_bg",col_pv_cb_col1_highlight:"col_list_highlight1",col_pv_cb_col2_highlight:"col_list_highlight2",col_pv_left_numbers:"col_list_highlight1",col_pv_pb:"col_outline",col_pv_pb_cell:"col_outline",col_pv_mutesolo_col1:"col_medium_bg",col_pv_mutesolo_col2:"col_light_bg",col_pv_mutesolo_col1_highlight:"col_list_highlight1",col_pv_mutesolo_col2_highlight:"col_list_highlight2",col_list_sep_vertical:"col_sepline",col_tb_bg:"col_dark_ctrl",col_tb_fg_off:"col_text_bt",col_tb_fg_on:"col_light_ctrl"};function updateColsFrom(o){if(lockcols){for(const[e,t]of Object.entries(tobkitSimilarCols))if(t==o){colours[e]=colours[o];const t=cols_ordered.indexOf(e);t>=0&&update_swatch(t)}for(const[e,t]of Object.entries(tobkitSimilarCols))if(e==o&&colours[t]){colours[o]=colours[t];const e=cols_ordered.indexOf(o);e>=0&&update_swatch(e)}}}function stringToRGB15(o){const e=parseInt(o.substr(0,2),16),t=parseInt(o.substr(2,2),16);return parseInt(o.substr(4,2),16)>>3<<10|t>>3<<5|e>>3|32768}function interpolateColor(o,e,t){return((31&o)-(31&e))*t+((31&e)<<12)>>12|((o>>5&31)-(e>>5&31))*t+((e>>5&31)<<12)>>12<<5|((o>>10&31)-(e>>10&31))*t+((e>>10&31)<<12)>>12<<10|32768}function drawPixel(o,e,t,l){const r=8*(31&t),c=8*(t>>5&31),n=8*(t>>10&31);l.fillStyle=`rgb(${r},${c},${n})`,l.fillRect(o*scalexy,e*scalexy,scalexy,scalexy)}function drawFullBox(o,e,t,l,r,c){const n=8*(31&r),a=8*(r>>5&31),_=8*(r>>10&31);c.fillStyle=`rgb(${n},${a},${_})`,c.fillRect(o*scalexy,e*scalexy,t*scalexy,l*scalexy)}function drawGradient(o,e,t,l,r,c,n){if(r==c)return void drawFullBox(o,e,t,l,r,n);const a=Math.floor(4096/l);let _=0;for(let s=0;s<l;s++,_+=a){const l=interpolateColor(r,c,_),a=8*(31&l),i=8*(l>>5&31),d=8*(l>>10&31);n.fillStyle=`rgb(${a},${i},${d})`,n.fillRect(o*scalexy,(e+s)*scalexy,t*scalexy,1*scalexy)}}function drawBorder(o,e,t,l,r,c){drawFullBox(o,e,t,1,r,c),drawFullBox(o,e+l-1,t,1,r,c),drawFullBox(o,e,1,l,r,c),drawFullBox(o+t-1,e,1,l,r,c)}function drawHLine(o,e,t,l,r){drawFullBox(o,e,t,1,l,r)}function drawVLine(o,e,t,l,r){drawFullBox(o,e,1,t,l,r)}function drawString(o,e,t,l,r,c,n){if(!font_loaded)return;const a=document.createElement("canvas");a.width=font_img.width,a.height=font_img.height;const _=a.getContext("2d");_.drawImage(font_img,0,0);const s=_.getImageData(0,0,font_img.width,font_img.height).data;let i=0;for(let a of o){const o=a.charCodeAt(0),_=font_index[o],d=font_widths[_];if(r&&i+d>r)break;const u=c?Math.min(11,c):11;for(let o=0;o<u;o++)for(let r=0;r<8;r++){const c=8*_+r,a=o;if(c<font_img.width&&a<font_img.height){s[4*(a*font_img.width+c)]<128&&drawPixel(e+i+r,t+o,l,n)}}i+=d+1}}function drawMonochromeIcon(o,e,t,l,r,c,n){const a=icons[r];let _=0;for(let r=0;r<l;r++)for(let l=0;l<t;l++,_++)a.bits[_]&&drawPixel(o+l,e+r,c,n)}function drawMiniChar(o,e,t,l,r){const c=[146,214,251,191,230,253,174,222,116,154,230,183,109,15,20,93,217,132,109,155,38,169,212,188,109,27,181,109,9,28,21,245,93,255,151,110,189,180,188,93,39,181,151,164,23,149,72,86,101,155,38,173,212,180,205,74,245,175,2,28,250,199,61,95,231,61,174,210,183,138,59,89,173,14,20],n=8*(31&l),a=8*(l>>5&31),_=8*(l>>10&31);r.fillStyle=`rgb(${n},${a},${_})`;for(let l=0;l<5;l++)for(let n=0;n<3;n++){const a=120*l+3*o+n;c[Math.floor(a/8)]&1<<a%8&&r.fillRect((e+n)*scalexy,(t+l)*scalexy,scalexy,scalexy)}}function drawHexByte(o,e,t,l,r){drawMiniChar(Math.floor(o/16),e,t,l,r),drawMiniChar(o%16,e+pv_char_w,t,l,r)}function drawCell(o,e,t,l,r,c){const n=stringToRGB15(r?colours.col_pv_notes_dark:colours.col_pv_notes),a=stringToRGB15(r?colours.col_pv_instr_dark:colours.col_pv_instr),_=stringToRGB15(r?colours.col_pv_volume_dark:colours.col_pv_volume),s=pv_border_w+1+t*pv_cellw,i=2+l*pv_char_h,d=Math.floor(96*Math.random()),u=Math.floor(128*Math.random()),h=Math.floor(128*Math.random()),g=[12,12,13,13,14,15,15,16,16,10,10,17],b=[0,1,0,1,0,0,1,0,1,0,1,0];Math.random()>.3&&(drawMiniChar(g[d%12],s,i,n,c),drawMiniChar(b[d%12]?38:37,s+pv_char_w,i,n,c),drawMiniChar(Math.floor(d/12),s+2*pv_char_w,i,n,c)),Math.random()>.5&&drawHexByte(u+1,s+3*pv_char_w+1,i,a,c),Math.random()>.5&&drawHexByte(h,s+5*pv_char_w+2,i,_,c)}function drawGradientIcon(o,e,t,l,r,c){if(!logo_loaded)return;const n=stringToRGB15(colours.col_light_ctrl),a=stringToRGB15(colours.col_dark_ctrl),_=stringToRGB15(colours.col_outline),s=document.createElement("canvas");s.width=r.width,s.height=r.height;const i=s.getContext("2d");i.drawImage(r,0,0);const d=i.getImageData(0,0,r.width,r.height).data;for(let s=0;s<l&&s<r.height;s++){const i=interpolateColor(n,a,Math.floor(s/l*4096));for(let l=0;l<t&&l<r.width;l++){const t=4*(s*r.width+l),n=d[t],a=d[t+1],u=d[t+2];n>128&&a<128&&u>128||drawPixel(o+l,e+s,n<128&&a<128&&u<128?_:i,c)}}}function drawPiano(o,e,t,l,r){if(!piano_loaded)return;const c=document.createElement("canvas");c.width=piano_img.width,c.height=piano_img.height;const n=c.getContext("2d");n.drawImage(piano_img,0,0);const a=n.getImageData(0,0,piano_img.width,piano_img.height).data;for(let c=0;c<l&&c<piano_img.height;c++)for(let l=0;l<t&&l<piano_img.width;l++){const t=4*(c*piano_img.width+l),n=a[t],_=a[t+1];drawPixel(o+l,e+c,a[t+2]>>3<<10|_>>3<<5|n>>3|32768,r)}}function drawButton(o,e,t,l,r,c,n){const a=stringToRGB15(colours.col_light_ctrl),_=stringToRGB15(colours.col_dark_ctrl),s=stringToRGB15(colours.col_outline),i=stringToRGB15(colours.col_text_bt);c?drawGradient(o+1,e+1,t-2,l-2,a,_,n):drawGradient(o+1,e+1,t-2,l-2,_,a,n),drawBorder(o,e,t,l,s,n);let d=0;for(let o of r){const e=o.charCodeAt(0),t=font_index[e];d+=font_widths[t]+1}d-=1,drawString(r,o+(t-d)/2|0,e+l/2-5|0,i,255,255,n)}function drawBitButton(o,e,t,l,r,c,n,a,_,s,i){const d=stringToRGB15(colours.col_light_ctrl),u=stringToRGB15(colours.col_dark_ctrl),h=stringToRGB15(colours.col_light_ctrl_disabled),g=stringToRGB15(colours.col_dark_ctrl_disabled),b=stringToRGB15(colours.col_outline),m=stringToRGB15(colours.col_icon);Math.random()<=.5?c?drawGradient(o+1,e+1,t-2,l-2,d,u,i):drawGradient(o+1,e+1,t-2,l-2,u,d,i):drawGradient(o+1,e+1,t-2,l-2,g,h,i),drawBorder(o,e,t,l,b,i),drawMonochromeIcon(o+_,e+s,a,n,r,m,i)}function drawCheckbox(o,e,t,l,r,c,n,a){const _=stringToRGB15(colours.col_light_ctrl),s=stringToRGB15(colours.col_dark_ctrl),i=stringToRGB15(colours.col_outline),d=stringToRGB15(colours.col_text),u=stringToRGB15(colours.col_checkmark);n?drawFullBox(o,e,11,3,stringToRGB15(colours.col_bg),a):drawFullBox(o,e,11,1,stringToRGB15(colours.col_light_bg),a),drawBorder(o+1,e+3,9,9,i,a),drawGradient(o+2,e+4,7,7,_,s,a),c&&drawMonochromeIcon(o+1,e,10,10,"haken",u,a);let h=0;for(let o of r){const e=o.charCodeAt(0),t=font_index[e];h+=font_widths[t]+1}h-=1,drawString(r,13+o,2+e,n?stringToRGB15(colours.col_text_light):d,255,255,a)}function drawTogglebutton(o,e,t,l,r,c,n,a){const _=stringToRGB15(colours.col_tb_bg),s=stringToRGB15(colours.col_outline),i=stringToRGB15(colours.col_tb_fg_on),d=stringToRGB15(colours.col_tb_fg_off),u=stringToRGB15(colours.col_signal_off);drawFullBox(o+1,e+1,t-2,l-2,_,a),drawBorder(o,e,t,l,s,a);const h=c?i:n?u:d;if(n)drawMonochromeIcon(o+2,e+2,12,12,n,h,a);else{let c=0;for(let o of r){const e=o.charCodeAt(0),t=font_index[e];c+=font_widths[t]+1}c>0&&(c-=1),drawString(r,o+Math.max(2,(t-c)/2|0),e+l/2-5|0,h,255,255,a)}}function drawLabel(o,e,t,l,r,c,n){drawString(r,o,e+l/2-5|0,stringToRGB15(c?colours.col_text_light:colours.col_text),255,255,n)}function drawNumberBox(o,e,t,l,r,c,n){const a=stringToRGB15(colours.col_light_ctrl),_=stringToRGB15(colours.col_dark_ctrl),s=stringToRGB15(colours.col_outline),i=stringToRGB15(colours.col_icon),d=stringToRGB15(colours.col_lighter_bg),u=stringToRGB15(colours.col_text_value);drawGradient(o+1,e+1,8,8,a,_,c);for(let t=0;t<3;t++)for(let l=-t;l<=t;l++)drawPixel(o+4+l,e+t+3,i,c);drawBorder(o,e,9,9,s,c),drawGradient(o+1,e+8,8,8,a,_,c);for(let t=2;t>=0;t--)for(let l=-t;l<=t;l++)drawPixel(o+4+l,e-t+13,i,c);drawBorder(o,e+8,9,9,s,c),drawFullBox(o+9,e+1,t-9,l-1,d,c),drawString(String(r).padStart(2," "),1==n?o+6:o+10,e+5,u,255,255,c),drawBorder(o,e,t,l,s,c)}function drawNumberSlider(o,e,t,l,r,c,n){const a=stringToRGB15(colours.col_light_ctrl),_=stringToRGB15(colours.col_dark_ctrl),s=stringToRGB15(colours.col_outline),i=stringToRGB15(colours.col_icon),d=stringToRGB15(colours.col_lighter_bg),u=stringToRGB15(colours.col_text_value);drawGradient(o+1,e+1,8,15,a,_,n);for(let t=0;t<3;t++)for(let l=-t;l<=t;l++)drawPixel(o+4+l,e+t+3,i,n);drawVLine(o+4,e+6,5,s,n);for(let t=2;t>=0;t--)for(let l=-t;l<=t;l++)drawPixel(o+4+l,e-t+13,i,n);drawBorder(o,e,9,17,s,n),drawFullBox(o+9,e+1,t-10,l-2,d,n);drawString(c?r.toString(16).padStart(2," "):String(r).padStart(3," "),o+10,e+5,u,255,255,n),drawBorder(o,e,t,l,s,n)}function drawMemoryIndicator(o,e,t,l,r){const c=stringToRGB15(colours.col_outline),n=stringToRGB15(colours.col_light_bg),a=stringToRGB15(colours.col_mem_ok),_=stringToRGB15(colours.col_mem_warn),s=stringToRGB15(colours.col_mem_alert),i=Math.floor((t-2)*mem_use/100);let d;d=mem_use<62?a:mem_use<78?interpolateColor(_,a,mem_use-62<<8):mem_use<94?interpolateColor(s,_,mem_use-78<<8):s,drawBorder(o,e,t,l,c,r),drawFullBox(o+1,e+1,t-2,l-2,n,r),drawFullBox(o+1,e+1,i,l-2,d,r)}function drawListBox(o,e,t,l,r,c,n){const a=11,_=Math.floor((l-1)/a),s=stringToRGB15(colours.col_outline),i=stringToRGB15(colours.col_sepline),d=stringToRGB15(colours.col_list_sep_vertical),u=stringToRGB15(colours.col_list_1),h=stringToRGB15(colours.col_list_2),g=stringToRGB15(colours.col_list_highlight1),b=stringToRGB15(colours.col_list_highlight2),m=stringToRGB15(colours.col_lighter_bg),f=stringToRGB15(colours.col_scrollbar_arr_bg2),p=stringToRGB15(colours.col_scrollbar_arr_bg1),w=stringToRGB15(colours.col_text_lb),v=stringToRGB15(colours.col_text_lb_highlight);for(let l=0;l<_-1;l++)drawHLine(o+1,e+a*(l+1),t-9-1,i,c);for(let l=0;l<_;l++){let r=u,n=h;0==l?(r=g,n=b):1==l&&(r=h,n=m),drawGradient(o+1,e+a*l+1,t-9-1,10,r,n,c)}r&&drawVLine(o+17,e+1,l-2,d,c),drawGradient(o+t-9+1,e+1,8,8,f,p,c);for(let l=0;l<3;l++)for(let r=-l;r<=l;r++)drawPixel(o+t-9+4+r,e+l+3,s,c);drawBorder(o+t-9,e,9,9,s,c),drawGradient(o+t-9+1,e+l-9,8,8,f,p,c);for(let r=2;r>=0;r--)for(let n=-r;n<=r;n++)drawPixel(o+t-9+4+n,e-r+l-4,s,c);drawBorder(o+t-9,e+l-9,9,9,s,c),drawBorder(o+t-9,e,9,l,s,c),drawGradient(o+t-9+1,e+9,7,l-18,stringToRGB15(colours.col_scrollbar_bg1),stringToRGB15(colours.col_scrollbar_bg2),c);if(!0!==n&&(drawFullBox(o+t-9+1,e+9+0,7,20,stringToRGB15(colours.col_scrollbar_inactive),c),drawBorder(o+t-9,e+9+0,9,20,s,c)),r){for(let t=0;t<Math.min(_,8);t++)drawString(" "+(t+1).toString(16),o+2,e+a*t+2,0==t?v:w,255,255,c);drawString("Text : D",o+19,e+2,v,t-19-2-9-2,l-6,c)}drawBorder(o,e,t,l,s,c)}function drawTabbox(o,e,t,l,r){const c=18,n=stringToRGB15(colours.col_tab_outline),a=stringToRGB15(colours.col_bg),_=stringToRGB15(colours.col_selected_tab),s=stringToRGB15(colours.col_light_bg),i=stringToRGB15(colours.col_unselected_tab),d=stringToRGB15(colours.col_icon_tab);drawFullBox(o+1,e+c+1,t-2,l-20,s,r),drawBorder(o,e+c,t,l-c,n,r),drawFullBox(o,e,93,3,a,r);const u=["icon_song","icon_disk","icon_sample","icon_trumpet","icon_wrench"];for(let t=0;t<5;t++){const l=0==t,a=l?0:3;drawFullBox(o+3+c*t,e+1+a,c,c-a,l?_:i,r),drawVLine(o+2+c*t,e+1+a,c-a,n,r),drawHLine(o+3+c*t,e+a,c,n,r),drawVLine(o+2+c*(t+1),e+1+a,c-a,n,r),drawMonochromeIcon(o+4+c*t,e+2+a,16,16-a,u[t],d,r)}}function drawSub(){drawFullBox(0,0,256,192,stringToRGB15(colours.col_bg),fb_sub),drawTabbox(1,1,139,151,fb_sub),drawListBox(4,21,50,78,!0,fb_sub),drawButton(70,47,14,12,">",!1,fb_sub),drawButton(55,47,14,12,"<",!1,fb_sub),drawButton(55,21,29,12,"ins",!1,fb_sub),drawButton(55,60,29,12,"del",!1,fb_sub),drawButton(55,34,29,12,"cln",!1,fb_sub),drawGradientIcon(98,1,80,17,logo_img,fb_sub),drawBitButton(180,3,23,15,"icon_play",!1,12,12,5,0,fb_sub),drawBitButton(204,3,23,15,"icon_stop",!0,12,12,5,0,fb_sub),drawBitButton(236,1,19,19,"icon_flp",!1,15,15,2,2,fb_sub),drawTogglebutton(55,74,29,12,"lock",!0,null,fb_sub),drawTogglebutton(55,87,29,12,"loop",!1,null,fb_sub),drawTogglebutton(141,136,16,16,"",!1,"icon_record",fb_sub),drawTogglebutton(165,20,10,10,"+",!1,null,fb_sub),drawCheckbox(179,18,30,12,"scr lock",!0,!0,fb_sub),drawLabel(87,48,50,12,"ptn len:",!1,fb_sub),drawNumberSlider(105,60,32,17,16,!0,fb_sub),drawLabel(87,22,48,12,"chn:  4",!1,fb_sub),drawButton(112,34,12,12,"-",!1,fb_sub),drawButton(125,34,12,12,"+",!1,fb_sub),drawLabel(4,103,32,12,"tmp",!1,fb_sub),drawLabel(38,103,32,12,"bpm",!1,fb_sub),drawLabel(72,103,46,12,"restart",!1,fb_sub),drawNumberBox(4,115,32,17,6,fb_sub),drawLabel(182,126,22,12,"add",!0,fb_sub),drawLabel(206,126,25,12,"oct",!0,fb_sub),drawNumberBox(185,135,18,17,6,fb_sub,!0),drawNumberBox(206,135,18,17,4,fb_sub,!0),drawNumberSlider(38,115,32,17,120,!1,fb_sub),drawNumberSlider(72,115,32,17,0,!0,fb_sub),drawLabel(4,134,113,14,"unnamed",!1,fb_sub),drawButton(118,134,20,14,"...",!1,fb_sub),drawButton(141,19,23,12,"ren",!1,fb_sub),drawButton(107,116,30,14,"zap!",!1,fb_sub),drawLabel(87,78,52,12,"ram use",!1,fb_sub),drawMemoryIndicator(87,90,50,8,fb_sub),drawListBox(141,32,114,89,!0,fb_sub),drawBitButton(225,127,14,12,"icon_undo",!1,8,8,3,2,fb_sub),drawBitButton(241,127,14,12,"icon_redo",!1,8,8,3,2,fb_sub),drawButton(225,140,30,12,"ins",!1,fb_sub),drawButton(225,153,30,12,"del",!1,fb_sub),drawButton(225,166,30,12,"clr",!1,fb_sub),drawButton(225,179,30,12,"--",!1,fb_sub),drawPiano(0,152,224,40,fb_sub)}function drawMain(){if(!font_loaded||!font_3x5_loaded)return;sel_x1=Math.floor(Math.random()*pv_cols),sel_y1=Math.floor(10*Math.random()),sel_x2=sel_x1+1+Math.floor(Math.random()*(pv_cols-sel_x1)),sel_y2=sel_y1+1+Math.floor(5*Math.random());const o=stringToRGB15(colours.col_pv_bg),e=8*(31&o),t=8*(o>>5&31),l=8*(o>>10&31);fb_main.fillStyle=`rgb(${e},${t},${l})`,fb_main.fillRect(0,0,256*scalexy,192*scalexy);const r=stringToRGB15(colours.col_pv_lines),c=stringToRGB15(colours.col_pv_pb),n=stringToRGB15(colours.col_pv_pb_cell),a=stringToRGB15(colours.col_pv_left_numbers),_=stringToRGB15(colours.col_pv_left_numbers_highlight),s=stringToRGB15(colours.col_pv_chn),i=Math.floor(192/pv_cell_h),d=Math.floor(i/2)-1,u=5-d,h=pv_border_w+pv_cols*pv_cellw,g=pv_border_w+(sel_x1-0)*pv_cellw,b=g+(sel_x2-sel_x1)*pv_cellw,m=(sel_y1-u)*pv_cell_h,f=m+(sel_y2-sel_y1)*pv_cell_h;if(!(g>=h||b<=0||m>=192||f<=0)){const o=Math.max(g,0),e=Math.min(b,h),t=Math.max(m,0);drawFullBox(o,t,e-o,Math.min(f,192)-t+1,stringToRGB15(colours.col_pv_cb_sel_highlight),fb_main)}for(let o=0;o<=i;o++){const e=o-d+5;e>=0&&e<=pv_rows&&(e%4==0?drawHLine(0,pv_cell_h*o,pv_border_w+pv_cols*pv_cellw,r,fb_main):drawHLine(pv_border_w,pv_cell_h*o,pv_cols*pv_cellw,stringToRGB15(colours.col_pv_sublines),fb_main))}for(let o=0;o<=pv_cols;o++)drawVLine(pv_border_w-1+o*pv_cellw,0,192,r,fb_main);if(drawGradient(0,pv_cursorbar_y,pv_border_w+pv_cols*pv_cellw,pv_cell_h,stringToRGB15(colours.col_pv_cb_col1),stringToRGB15(colours.col_pv_cb_col2),fb_main),drawBorder(0,pv_cursorbar_y,pv_border_w+pv_cols*pv_cellw,pv_cell_h+1,c,fb_main),m<=pv_cursorbar_y+1&&f>=pv_cursorbar_y+1+pv_cell_h-1&&g<=pv_border_w+pv_cols*pv_cellw&&b>=pv_border_w){const o=Math.max(g,pv_border_w+1);drawFullBox(o,pv_cursorbar_y+1,b-o-1,pv_cell_h-1,stringToRGB15(colours.col_pv_cb_sel_highlight),fb_main)}drawFullBox(pv_border_w-1,pv_cursorbar_y,pv_cellw+1,pv_cell_h+1,n,fb_main),drawGradient(pv_border_w,pv_cursorbar_y+1,pv_cellw-1,pv_cell_h-1,stringToRGB15(colours.col_pv_cb_col1_highlight),stringToRGB15(colours.col_pv_cb_col2_highlight),fb_main);for(let o=5-d;o<=5+d+1;o++)o>=0&&o<pv_rows&&drawHexByte(o,1,2+(o+d-5)*pv_char_h,o%4==0?_:a,fb_main);const p=d;for(let o=0;o<pv_cols;o++)for(let e=0;e<i;e++)u+e>=0&&u+e<pv_rows&&drawCell(o,u+e,o,e,e==p,fb_main);for(let e=0;e<pv_cols;e++){drawFullBox(pv_border_w+e*pv_cellw+1,1,pv_cellw-2,11,o,fb_main);drawString(e.toString(16).padStart(2,"0"),pv_border_w+e*pv_cellw+1,1,s,255,255,fb_main)}const w=stringToRGB15(colours.col_pv_mutesolo_text);for(let o=0;o<pv_cols;o++){const e=1==o,t=2==o,l=stringToRGB15(e?colours.col_pv_mutesolo_col1_highlight:colours.col_pv_mutesolo_col1),r=stringToRGB15(e?colours.col_pv_mutesolo_col2_highlight:colours.col_pv_mutesolo_col2);drawGradient(pv_border_w+o*pv_cellw+9,1,10,9,l,r,fb_main),drawString("m",pv_border_w+o*pv_cellw+9+1,0,w,255,255,fb_main);const c=stringToRGB15(t?colours.col_pv_mutesolo_col1_highlight:colours.col_pv_mutesolo_col1),n=stringToRGB15(t?colours.col_pv_mutesolo_col2_highlight:colours.col_pv_mutesolo_col2);drawGradient(pv_border_w+o*pv_cellw+20,1,10,9,c,n,fb_main),drawString("s",pv_border_w+o*pv_cellw+20+2,0,w,255,255,fb_main)}drawBitButton(236,1,19,19,"icon_flp",!1,15,15,2,2,fb_main),drawButton(225,22,30,12,"-m/s",!1,fb_main),drawLabel(230,34,25,9,"vol",!0,fb_main),drawNumberSlider(225,45,30,17,127,!0,fb_main),drawButton(225,61,30,12,"set",!1,fb_main),drawButton(225,74,14,12,"-",!1,fb_main),drawButton(241,74,14,12,"+",!1,fb_main),drawButton(225,88,30,12,"cut",!1,fb_main),drawButton(225,101,30,12,"cp",!1,fb_main),drawButton(225,114,30,12,"pst",!1,fb_main),drawButton(225,127,30,12,"sel",!1,fb_main),drawButton(225,140,30,12,"ins",!1,fb_main),drawButton(225,153,30,12,"del",!1,fb_main),drawButton(225,166,30,12,"clr",!1,fb_main),drawButton(225,179,30,12,"--",!1,fb_main)}function redraw(){drawSub(),drawMain()}function save_theme(){const o=document.getElementById("theme-name").value||"theme",e=cols_ordered.map((o=>cols_ordered.indexOf(o)+"="+colours[o]+" ; "+colscheme[o].name)).join("\n"),t=new Blob([e],{type:"text/plain"}),l=document.createElement("a");l.href=URL.createObjectURL(t),o.endsWith(".nttheme")?l.download=o:l.download=o+".nttheme",l.click()}function select_swatch(o){active=o,document.querySelectorAll(".swatch").forEach(((e,t)=>{e.classList.toggle("active",cols_ordered[t]==o)})),colours[o]&&color_to_pos(tinycolor("#"+colours[o]))}function update_input(){inp.value=cols_ordered.map((o=>cols_ordered.indexOf(o)+"="+colours[o]+" ; "+colscheme[o].name)).join("\n")}function update_swatch(o){const e=swatch_list.children[o],t=cols_ordered[o];e.querySelector(".swatchcol").style.backgroundColor="#"+colours[t]}function parse_theme(o){const e=o.split("\n"),t={};let l=0;for(let o of e){l++;const e=o.trim();if(!e)continue;const r=e.match(/^(\d+)=([0-9a-fA-F]{6})/);if(!r)return parseres.textContent=`bad parse: line ${l}`,null;const c=parseInt(r[1],10),n=r[2].toLowerCase();if(c<0||c>=cols_ordered.length)return parseres.textContent=`bad parse: line ${l} key ${c} out of bounds (max ${cols_ordered.length-1})`,null;const a=cols_ordered[c];a&&(t[a]=n)}for(const o of cols_ordered)t[o]||(t[o]="000000");return t}function loadDefCols(){if(!(Object.keys(colours).length>0)||confirm("lose progress and use default skin?")){colours={},base_colours={};for(const o of cols_ordered)colours[o]=colscheme[o].hex,base_colours[o]=colscheme[o].hex;update_input(),inp.disabled=!1,load_btn.disabled=!1,parseres.textContent="";for(let o=0;o<cols_ordered.length;o++)update_swatch(o);redraw()}}function loadTheme(){const o=parse_theme(inp.value);if(o){colours=o,base_colours={};for(const e in o)base_colours[e]=o[e];inp.disabled=!1,load_btn.disabled=!1,parseres.textContent="";for(let o=0;o<cols_ordered.length;o++)update_swatch(o);redraw()}}function draw_spectrum(o){spec_ctx.clearRect(0,0,spec_canvas.width,spec_canvas.height),o||(o="#f00"),spec_ctx.fillStyle=o,spec_ctx.fillRect(0,0,spec_canvas.width,spec_canvas.height);const e=spec_ctx.createLinearGradient(0,0,spec_canvas.width,0);e.addColorStop(0,"#fff"),e.addColorStop(1,"transparent"),spec_ctx.fillStyle=e,spec_ctx.fillRect(0,0,spec_canvas.width,spec_canvas.height);const t=spec_ctx.createLinearGradient(0,0,0,spec_canvas.height);t.addColorStop(0,"transparent"),t.addColorStop(1,"#000"),spec_ctx.fillStyle=t,spec_ctx.fillRect(0,0,spec_canvas.width,spec_canvas.height)}function color_to_pos(o){const e=o.toHsl();hue=e.h;const t=o.toHsv(),l=spec_canvas.width*t.s,r=spec_canvas.height*(1-t.v),c=hue/360*hue_canvas.width;spec_cursor.style.left=l+"px",spec_cursor.style.top=r+"px",hue_cursor.style.left=c+"px",spec_cursor.style.backgroundColor=o.toHexString(),hue_cursor.style.backgroundColor="hsl("+hue+",100%,50%)",draw_spectrum("hsl("+hue+",100%,50%)")}function get_spec_color(o){o.preventDefault();const e=spec_canvas.getBoundingClientRect();let t=o.pageX-e.left,l=o.pageY-e.top;t=Math.max(0,Math.min(e.width,t)),l=Math.max(0,Math.min(e.height,l));const r=t/e.width,c=1-l/e.height;lit=c/2*(2-r),sat=c*r/(1-Math.abs(2*lit-1));const n=tinycolor("hsl "+hue+" "+sat+" "+lit);if(spec_cursor.style.left=t+"px",spec_cursor.style.top=l+"px",spec_cursor.style.backgroundColor=n.toHexString(),active){colours[active]=n.toHex(),base_colours[active]=n.toHex(),updateColsFrom(active);const o=cols_ordered.indexOf(active);o>=0&&update_swatch(o),update_input(),redraw()}}function get_hue_colour(o){o.preventDefault();const e=hue_canvas.getBoundingClientRect();let t=o.pageX-e.left;t=Math.max(0,Math.min(e.width,t)),hue=t/e.width*360;const l="hsl("+hue+",100%,50%)";draw_spectrum(l),hue_cursor.style.left=t+"px",hue_cursor.style.backgroundColor=l;const r=tinycolor("hsl "+hue+" "+sat+" "+lit);if(spec_cursor.style.backgroundColor=r.toHexString(),active){colours[active]=r.toHex(),base_colours[active]=r.toHex(),updateColsFrom(active);const o=cols_ordered.indexOf(active);o>=0&&update_swatch(o),update_input(),redraw()}}function rgbToHsl(o,e,t){o/=255,e/=255,t/=255;let l=Math.min(o,e,t),r=Math.max(o,e,t),c=r-l,n=0,a=0,_=0;return n=0===c?0:r===o?(e-t)/c%6:r===e?(t-o)/c+2:(o-e)/c+4,n=Math.round(60*n),n<0&&(n+=360),_=(r+l)/2,a=0===c?0:c/(1-Math.abs(2*_-1)),a=+(100*a).toFixed(1),_=+(100*_).toFixed(1),[n,a,_]}spec_canvas.addEventListener("mousedown",(function(o){get_spec_color(o),spec_cursor.classList.add("dragging");const e=o=>get_spec_color(o),t=()=>{spec_cursor.classList.remove("dragging"),window.removeEventListener("mousemove",e),window.removeEventListener("mouseup",t)};window.addEventListener("mousemove",e),window.addEventListener("mouseup",t)})),hue_canvas.addEventListener("mousedown",(function(o){get_hue_colour(o),hue_cursor.classList.add("dragging");const e=o=>get_hue_colour(o),t=()=>{hue_cursor.classList.remove("dragging"),window.removeEventListener("mousemove",e),window.removeEventListener("mouseup",t)};window.addEventListener("mousemove",e),window.addEventListener("mouseup",t)}));const hslToRgb=(o,e,t)=>{t/=100;const l=e=>(e+o/30)%12,r=(e/=100)*Math.min(t,1-t),c=o=>t-r*Math.max(-1,Math.min(l(o)-3,Math.min(9-l(o),1)));return[Math.round(255*c(0)),Math.round(255*c(8)),Math.round(255*c(4))]};function stringToHsl(o){return rgbToHsl(parseInt(o.substr(0,2),16),parseInt(o.substr(2,2),16),parseInt(o.substr(4,2),16))}function hslToString(o,e,t){const[l,r,c]=hslToRgb(o,e,t);return(l<<16|r<<8|c).toString(16).padStart(6,"0")}function hueshift(o,e){const[t,l,r]=stringToHsl(o);return hslToString((t+e)%360,l,r)}function randcols(){for(const o of cols_ordered){colours[o]=Math.floor(16777216*Math.random()).toString(16).padStart(6,"0"),base_colours[o]=colours[o];const e=cols_ordered.indexOf(o);e>=0&&update_swatch(e)}update_input(),redraw()}document.getElementById("hueshifter").addEventListener("input",(o=>{const e=parseInt(o.target.value,10);for(const o of cols_ordered){colours[o]=hueshift(base_colours[o],e);const t=cols_ordered.indexOf(o);t>=0&&update_swatch(t)}update_input(),redraw()})),swatch_list.innerHTML="";for(let o=0;o<cols_ordered.length;o++){const e=cols_ordered[o],t=document.createElement("div");t.className="swatch";const l=document.createElement("div");l.className="swatchcol";const r=document.createElement("span");r.className="swatchlb",r.textContent=colscheme[e].name,t.appendChild(l),t.appendChild(r),t.onclick=()=>select_swatch(e),swatch_list.appendChild(t)}const grad=hue_ctx.createLinearGradient(0,0,hue_canvas.width,0);grad.addColorStop(0,"hsl(0,100%,50%)"),grad.addColorStop(.17,"hsl(61.2,100%,50%)"),grad.addColorStop(.33,"hsl(118.8,100%,50%)"),grad.addColorStop(.5,"hsl(180,100%,50%)"),grad.addColorStop(.67,"hsl(241.2,100%,50%)"),grad.addColorStop(.83,"hsl(298.8,100%,50%)"),grad.addColorStop(1,"hsl(360,100%,50%)"),hue_ctx.fillStyle=grad,hue_ctx.fillRect(0,0,hue_canvas.width,hue_canvas.height),draw_spectrum(),loadDefCols(),document.getElementById("cb_lock").addEventListener("change",(o=>{lockcols=o.target.checked}));
